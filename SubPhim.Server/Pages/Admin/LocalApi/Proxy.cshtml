@page
@model SubPhim.Server.Pages.Admin.LocalApi.ProxyModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω Proxy";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>@ViewData["Title"]</h1>
        <p class="text-muted mb-0">Qu·∫£n l√Ω danh s√°ch proxy ƒë·ªÉ lu√¢n phi√™n khi g·ªçi API Google, tr√°nh gi·ªõi h·∫°n 429 Too Many Requests.</p>
    </div>
    <div>
        <span class="badge bg-@(Model.ActiveProxyCount > 0 ? "success" : "warning") fs-6">
            <i class="bi bi-router me-1"></i>@Model.ActiveProxyCount proxy ƒëang ho·∫°t ƒë·ªông
        </span>
    </div>
</div>
<hr />

<div class="row">
    <!-- TH√äM PROXY M·ªöI -->
    <div class="col-lg-5 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Th√™m Proxy M·ªõi</h5>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="AddProxies">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label fw-bold">Danh s√°ch Proxy (m·ªói d√≤ng m·ªôt proxy)</label>
                        <textarea name="proxyList" class="form-control font-monospace" rows="8" placeholder="H·ªó tr·ª£ c√°c ƒë·ªãnh d·∫°ng:
socks5://host:port
socks4://host:port
http://host:port
socks5://username:password@host:port
host:port (m·∫∑c ƒë·ªãnh l√† SOCKS5)

V√≠ d·ª•:
socks5://192.168.1.1:1080
http://admin:pass123@proxy.example.com:8080
127.0.0.1:9050"></textarea>
                    </div>
                    <div class="alert alert-info py-2 mb-3">
                        <small>
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>ƒê·ªãnh d·∫°ng h·ªó tr·ª£:</strong><br/>
                            ‚Ä¢ <code>socks5://host:port</code> - SOCKS5 proxy<br/>
                            ‚Ä¢ <code>socks4://host:port</code> - SOCKS4 proxy<br/>
                            ‚Ä¢ <code>http://host:port</code> - HTTP proxy<br/>
                            ‚Ä¢ <code>type://user:pass@host:port</code> - Proxy v·ªõi authentication<br/>
                            ‚Ä¢ <code>host:port</code> - M·∫∑c ƒë·ªãnh l√† SOCKS5
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-plus-lg me-2"></i>Th√™m Proxy
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- DANH S√ÅCH PROXY -->
    <div class="col-lg-7 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Danh s√°ch Proxy</h5>
                <div>
                    <form method="post" asp-page-handler="CheckAllProxies" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-info btn-sm me-2" @(Model.IsCheckRunning ? "disabled" : "")>
                            @if (Model.IsCheckRunning)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                <text>ƒêang ki·ªÉm tra...</text>
                            }
                            else
                            {
                                <i class="bi bi-speedometer2 me-1"></i>
                                <text>Ki·ªÉm tra t·∫•t c·∫£</text>
                            }
                        </button>
                    </form>
                    <form method="post" asp-page-handler="DeleteAllProxies" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA T·∫§T C·∫¢ proxy?');">
                            <i class="bi bi-trash3 me-1"></i>X√≥a t·∫•t c·∫£
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body p-0">
                <form method="post">
                    @Html.AntiForgeryToken()
                    <div class="mb-2 p-2 border-bottom bg-light d-flex flex-wrap gap-2 align-items-center">
                        <button type="submit" class="btn btn-sm btn-outline-danger" asp-page-handler="DeleteSelectedProxies" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA c√°c proxy ƒë√£ ch·ªçn?');">
                            <i class="bi bi-trash"></i> X√≥a ƒë√£ ch·ªçn
                        </button>
                        <button type="submit" class="btn btn-sm btn-outline-warning" asp-page-handler="DisableSelectedProxies" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën T·∫ÆT c√°c proxy ƒë√£ ch·ªçn?');">
                            <i class="bi bi-power"></i> T·∫Øt ƒë√£ ch·ªçn
                        </button>
                        <button type="submit" class="btn btn-sm btn-outline-success" asp-page-handler="EnableSelectedProxies" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën B·∫¨T c√°c proxy ƒë√£ ch·ªçn?');">
                            <i class="bi bi-check-circle"></i> B·∫≠t ƒë√£ ch·ªçn
                        </button>
                        <span class="badge bg-info ms-auto">
                            <i class="bi bi-speedometer2 me-1"></i>@Model.MeasuredProxyCount/@Model.Proxies.Count ƒë√£ ƒëo latency
                        </span>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-striped table-hover table-sm mb-0">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th class="text-center" style="width: 5%;"><input class="form-check-input" type="checkbox" id="selectAll"></th>
                                    <th>Proxy</th>
                                    <th class="text-center">Lo·∫°i</th>
                                    <th class="text-center">Latency</th>
                                    <th class="text-center">S·ª≠ d·ª•ng</th>
                                    <th class="text-center">L·ªói</th>
                                    <th class="text-center">Tr·∫°ng th√°i</th>
                                    <th class="text-center">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Proxies.Any())
                                {
                                    @foreach (var proxy in Model.Proxies)
                                    {
                                        var typeBadgeClass = proxy.Type switch
                                        {
                                            SubPhim.Server.Data.ProxyType.Socks5 => "bg-primary",
                                            SubPhim.Server.Data.ProxyType.Socks4 => "bg-info",
                                            SubPhim.Server.Data.ProxyType.Http => "bg-secondary",
                                            _ => "bg-dark"
                                        };
                                        
                                        // Latency color based on value
                                        var latencyBadgeClass = proxy.LatencyMs switch
                                        {
                                            null => "bg-secondary",
                                            <= 100 => "bg-success",
                                            <= 300 => "bg-info",
                                            <= 500 => "bg-warning text-dark",
                                            _ => "bg-danger"
                                        };
                                        
                                        <tr class="@(!proxy.IsEnabled ? "table-secondary" : "")">
                                            <td class="text-center"><input class="form-check-input proxy-checkbox" type="checkbox" name="selectedProxyIds" value="@proxy.Id"></td>
                                            <td>
                                                <code class="@(!proxy.IsEnabled ? "text-muted" : "")">@proxy.Host:@proxy.Port</code>
                                                @if (!string.IsNullOrEmpty(proxy.Username))
                                                {
                                                    <span class="badge bg-info ms-1" title="C√≥ authentication">
                                                        <i class="bi bi-key"></i>
                                                    </span>
                                                }
                                                @if (!string.IsNullOrEmpty(proxy.LastFailureReason))
                                                {
                                                    <br/><small class="text-danger" title="@proxy.LastFailureReason">
                                                        <i class="bi bi-exclamation-triangle"></i> @(proxy.LastFailureReason?.Length > 50 ? proxy.LastFailureReason.Substring(0, 50) + "..." : proxy.LastFailureReason)
                                                    </small>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <span class="badge @typeBadgeClass">@proxy.Type</span>
                                            </td>
                                            <td class="text-center">
                                                @if (proxy.LatencyMs.HasValue)
                                                {
                                                    <span class="badge @latencyBadgeClass" title="@(proxy.LatencyCheckStatus ?? "OK")">
                                                        @proxy.LatencyMs ms
                                                    </span>
                                                    @if (proxy.LastLatencyCheckUtc.HasValue)
                                                    {
                                                        <br/><small class="text-muted">@proxy.LastLatencyCheckUtc.Value.ToString("dd/MM HH:mm")</small>
                                                    }
                                                }
                                                else if (!string.IsNullOrEmpty(proxy.LatencyCheckStatus))
                                                {
                                                    <span class="badge bg-danger" title="@proxy.LatencyCheckStatus">
                                                        <i class="bi bi-x-circle"></i>
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">N/A</span>
                                                }
                                                <br/>
                                                <button type="submit" asp-page-handler="CheckProxy" asp-route-id="@proxy.Id" class="btn btn-xs btn-outline-info p-0 px-1" title="Ki·ªÉm tra">
                                                    <i class="bi bi-speedometer2"></i>
                                                </button>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-success">@proxy.UsageCount</span>
                                                @if (proxy.LastUsedAt.HasValue)
                                                {
                                                    <br/><small class="text-muted">@proxy.LastUsedAt.Value.ToString("dd/MM HH:mm")</small>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <span class="badge @(proxy.FailureCount > 0 ? "bg-danger" : "bg-secondary")">@proxy.FailureCount</span>
                                            </td>
                                            <td class="text-center">
                                                <button type="submit" asp-page-handler="ToggleProxy" asp-route-id="@proxy.Id" class="btn btn-sm @(proxy.IsEnabled ? "btn-success" : "btn-secondary")">
                                                    @(proxy.IsEnabled ? "ON" : "OFF")
                                                </button>
                                            </td>
                                            <td class="text-center">
                                                <button type="submit" asp-page-handler="ResetProxyStats" asp-route-id="@proxy.Id" class="btn btn-sm btn-outline-info" title="Reset th·ªëng k√™">
                                                    <i class="bi bi-arrow-counterclockwise"></i>
                                                </button>
                                                <button type="submit" asp-page-handler="DeleteProxy" asp-route-id="@proxy.Id" class="btn btn-sm btn-outline-danger" onclick="return confirm('X√≥a proxy n√†y?');" title="X√≥a">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="7" class="text-center p-4">
                                            <i class="bi bi-router text-muted fs-1 d-block mb-2"></i>
                                            <span class="text-muted">Ch∆∞a c√≥ proxy n√†o. Th√™m proxy ƒë·ªÉ tr√°nh l·ªói 429 khi g·ªçi API Google.</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- KiotProxy Auto-Rotation Settings -->
<div class="card mt-3 border-warning">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>KiotProxy Auto-Rotation</h5>
        <span class="badge @(Model.KiotProxySettings.Enabled ? "bg-success" : "bg-secondary")">
            @(Model.KiotProxySettings.Enabled ? "ƒêang b·∫≠t" : "ƒê√£ t·∫Øt")
        </span>
    </div>
    <div class="card-body">
        <form method="post" asp-page-handler="UpdateKiotProxySettings">
            @Html.AntiForgeryToken()
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="kiotProxyEnabled" id="kiotProxyEnabled" 
                                   @(Model.KiotProxySettings.Enabled ? "checked" : "")>
                            <label class="form-check-label fw-bold" for="kiotProxyEnabled">
                                <i class="bi bi-lightning-charge me-1"></i>B·∫≠t t·ª± ƒë·ªông xoay proxy
                            </label>
                        </div>
                        <small class="text-muted">T·ª± ƒë·ªông l·∫•y v√† thay th·∫ø proxy t·ª´ KiotProxy API theo th·ªùi gian c√†i ƒë·∫∑t.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Danh s√°ch API Keys (m·ªói d√≤ng m·ªôt key)</label>
                        <textarea name="kiotProxyApiKeys" class="form-control font-monospace" rows="4" 
                                  placeholder="key1&#10;key2&#10;key3">@Model.KiotProxySettings.ApiKeys</textarea>
                        <small class="text-muted">M·ªói key s·∫Ω qu·∫£n l√Ω 1 proxy ri√™ng. Nhi·ªÅu key = nhi·ªÅu proxy.</small>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Th·ªùi gian xoay (ph√∫t)</label>
                            <input type="number" name="kiotProxyIntervalMinutes" class="form-control" 
                                   value="@Model.KiotProxySettings.IntervalMinutes" min="1" max="60">
                            <small class="text-muted">M·∫∑c ƒë·ªãnh: 5 ph√∫t</small>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">V√πng proxy</label>
                            <select name="kiotProxyRegion" class="form-select" id="kiotProxyRegion">
                                @{
                                    var regions = new[] { ("random", "üé≤ Ng·∫´u nhi√™n"), ("bac", "üèîÔ∏è Mi·ªÅn B·∫Øc"), ("trung", "üèñÔ∏è Mi·ªÅn Trung"), ("nam", "üå¥ Mi·ªÅn Nam") };
                                    foreach (var r in regions)
                                    {
                                        if (Model.KiotProxySettings.Region == r.Item1)
                                        {
                                            <option value="@r.Item1" selected>@r.Item2</option>
                                        }
                                        else
                                        {
                                            <option value="@r.Item1">@r.Item2</option>
                                        }
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Lo·∫°i proxy</label>
                        <select name="kiotProxyType" class="form-select" id="kiotProxyType">
                            @{
                                var types = new[] { ("socks5", "SOCKS5 (Khuy·∫øn ngh·ªã)"), ("http", "HTTP") };
                                foreach (var t in types)
                                {
                                    if (Model.KiotProxySettings.ProxyType == t.Item1)
                                    {
                                        <option value="@t.Item1" selected>@t.Item2</option>
                                    }
                                    else
                                    {
                                        <option value="@t.Item1">@t.Item2</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-save me-1"></i>L∆∞u c√†i ƒë·∫∑t
                        </button>
                        <button type="submit" asp-page-handler="ForceKiotProxyRotation" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-clockwise me-1"></i>Xoay ngay
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info py-2 mt-3 mb-0">
                <small>
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>C√°ch ho·∫°t ƒë·ªông:</strong> M·ªói API key s·∫Ω qu·∫£n l√Ω 1 proxy ri√™ng. 
                    Sau m·ªói interval, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ªçi API l·∫•y proxy m·ªõi, x√≥a proxy c≈© v√† th√™m proxy m·ªõi v√†o danh s√°ch.
                    Proxy t·ª± ƒë·ªông c√≥ ghi ch√∫ "KiotProxy Auto" ƒë·ªÉ d·ªÖ ph√¢n bi·ªát.
                </small>
            </div>
        </form>
    </div>
</div>

<!-- Th√¥ng tin h∆∞·ªõng d·∫´n -->
<div class="card mt-3">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Proxy</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-question-circle text-primary me-2"></i>T·∫°i sao c·∫ßn Proxy?</h6>
                <p class="small text-muted">
                    Khi g·ªçi API Google qu√° nhi·ªÅu t·ª´ c√πng m·ªôt IP, Google s·∫Ω tr·∫£ v·ªÅ l·ªói <strong>429 Too Many Requests</strong>. 
                    S·ª≠ d·ª•ng proxy gi√∫p ph√¢n t√°n c√°c request qua nhi·ªÅu IP kh√°c nhau, tr√°nh b·ªã rate limit.
                </p>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-gear text-primary me-2"></i>C√°ch ho·∫°t ƒë·ªông</h6>
                <p class="small text-muted">
                    H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông lu√¢n phi√™n (round-robin) qua danh s√°ch proxy khi g·ª≠i request ƒë·∫øn API Google.
                    N·∫øu kh√¥ng c√≥ proxy n√†o ƒë∆∞·ª£c c·∫•u h√¨nh, request s·∫Ω ƒë∆∞·ª£c g·ª≠i tr·ª±c ti·∫øp.
                </p>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-shield-check text-success me-2"></i>T·ª± ƒë·ªông v√¥ hi·ªáu h√≥a</h6>
                <p class="small text-muted mb-0">
                    Proxy s·∫Ω t·ª± ƒë·ªông b·ªã t·∫Øt n·∫øu g·∫∑p <strong>5 l·ªói li√™n ti·∫øp</strong>. 
                    B·∫°n c√≥ th·ªÉ reset th·ªëng k√™ v√† b·∫≠t l·∫°i proxy th·ªß c√¥ng.
                </p>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-router text-info me-2"></i>Lo·∫°i Proxy h·ªó tr·ª£</h6>
                <ul class="small text-muted mb-0">
                    <li><strong>SOCKS5</strong> - Khuy·∫øn ngh·ªã, h·ªó tr·ª£ authentication v√† UDP</li>
                    <li><strong>SOCKS4</strong> - Phi√™n b·∫£n c≈© h∆°n, kh√¥ng h·ªó tr·ª£ authentication</li>
                    <li><strong>HTTP</strong> - Proxy HTTP th√¥ng th∆∞·ªùng</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('click', function () {
                    const checkboxes = document.querySelectorAll('.proxy-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = selectAllCheckbox.checked;
                    });
                });
            }
        });
    </script>
}
